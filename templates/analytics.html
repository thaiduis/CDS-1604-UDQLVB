<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Quản lý văn bản</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #007bff;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/documents">
                <i class="fas fa-chart-line me-2"></i>Analytics
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/documents">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Overview Cards -->
        <div class="row" id="overviewCards">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-file-alt fa-2x text-primary"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="totalDocuments">-</div>
                            <div class="metric-label">Tổng tài liệu</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-tags fa-2x text-success"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="totalCategories">-</div>
                            <div class="metric-label">Danh mục</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-folder fa-2x text-warning"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="totalFolders">-</div>
                            <div class="metric-label">Thư mục</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-share-alt fa-2x text-info"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="totalShares">-</div>
                            <div class="metric-label">Chia sẻ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-pie me-2"></i>Phân bố theo danh mục</h5>
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-bar me-2"></i>Phân bố theo thư mục</h5>
                    <canvas id="folderChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Storage Stats -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-hdd me-2"></i>Phân bố dung lượng</h5>
                    <canvas id="storageChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line me-2"></i>Xu hướng theo tháng</h5>
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Most Shared Documents -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-star me-2"></i>Tài liệu được chia sẻ nhiều nhất</h5>
                    <div id="mostSharedList">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Coverage -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-search me-2"></i>Độ phủ tìm kiếm</h5>
                    <canvas id="searchCoverageChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-file me-2"></i>Loại tài liệu</h5>
                    <canvas id="fileTypeChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let categoryChart, folderChart, storageChart, monthlyChart, searchCoverageChart, fileTypeChart;

        async function loadAnalytics() {
            try {
                // Load dashboard data
                const response = await fetch('/api/analytics/dashboard');
                const data = await response.json();
                
                if (data.error) {
                    showError('Lỗi tải dữ liệu: ' + data.error);
                    return;
                }

                // Update overview cards
                document.getElementById('totalDocuments').textContent = data.overview.total_documents;
                document.getElementById('totalCategories').textContent = data.overview.total_categories;
                document.getElementById('totalFolders').textContent = data.overview.total_folders;
                document.getElementById('totalShares').textContent = data.overview.total_share_links;

                // Create charts
                createCategoryChart(data.by_category);
                createFolderChart(data.by_folder);
                createMonthlyChart(data.monthly_stats);
                createMostSharedList(data.most_shared);

                // Load additional data
                await loadSearchStats();
                await loadStorageStats();

            } catch (error) {
                console.error('Error loading analytics:', error);
                showError('Lỗi tải dữ liệu analytics');
            }
        }

        async function loadSearchStats() {
            try {
                const response = await fetch('/api/analytics/search-stats');
                const data = await response.json();
                
                if (!data.error) {
                    createSearchCoverageChart(data.search_coverage);
                }
            } catch (error) {
                console.error('Error loading search stats:', error);
            }
        }

        async function loadStorageStats() {
            try {
                const response = await fetch('/api/analytics/storage-stats');
                const data = await response.json();
                
                if (!data.error) {
                    createStorageChart(data.size_distribution);
                    createFileTypeChart(data.by_type);
                }
            } catch (error) {
                console.error('Error loading storage stats:', error);
            }
        }

        function createCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: data.map(item => item.color || '#007bff'),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createFolderChart(data) {
            const ctx = document.getElementById('folderChart').getContext('2d');
            if (folderChart) folderChart.destroy();
            
            folderChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        label: 'Số tài liệu',
                        data: data.map(item => item.count),
                        backgroundColor: data.map(item => item.color || '#28a745'),
                        borderColor: data.map(item => item.color || '#28a745'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createStorageChart(data) {
            const ctx = document.getElementById('storageChart').getContext('2d');
            if (storageChart) storageChart.destroy();
            
            storageChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => item.category),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createMonthlyChart(data) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            
            const labels = data.map(item => `${item.year}-${item.month.toString().padStart(2, '0')}`);
            const counts = data.map(item => item.count);
            
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tài liệu mới',
                        data: counts,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createSearchCoverageChart(data) {
            const ctx = document.getElementById('searchCoverageChart').getContext('2d');
            if (searchCoverageChart) searchCoverageChart.destroy();
            
            searchCoverageChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Nội dung', 'Tags', 'Danh mục', 'Thư mục'],
                    datasets: [{
                        label: 'Độ phủ (%)',
                        data: [data.content, data.tags, data.categories, data.folders],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function createFileTypeChart(data) {
            const ctx = document.getElementById('fileTypeChart').getContext('2d');
            if (fileTypeChart) fileTypeChart.destroy();
            
            fileTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.type),
                    datasets: [{
                        label: 'Số tài liệu',
                        data: data.map(item => item.count),
                        backgroundColor: '#17a2b8',
                        borderColor: '#17a2b8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createMostSharedList(data) {
            const container = document.getElementById('mostSharedList');
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted">Chưa có tài liệu nào được chia sẻ</p>';
                return;
            }
            
            const html = data.map((item, index) => `
                <div class="d-flex align-items-center mb-2 p-2 bg-light rounded">
                    <span class="badge bg-primary me-2">${index + 1}</span>
                    <div class="flex-grow-1">
                        <strong>${item.title}</strong>
                        <small class="text-muted d-block">ID: ${item.id}</small>
                    </div>
                    <span class="badge bg-success">${item.share_count} lần</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
            container.insertBefore(errorDiv, container.firstChild);
        }

        // Load analytics when page loads
        document.addEventListener('DOMContentLoaded', loadAnalytics);
    </script>
</body>
</html>

